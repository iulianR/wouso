{% extends base_template %}
{% load artifacts %}
{% load user %}
{% load i18n %}

{% block title %}{{ group }}{% endblock %}
{% block scripts %}
    <script type="text/javascript" src="{{ basepath }}/static/js/tabs.js"></script>
    <script type="text/javascript" src="{{ basepath }}/static/js/jquery.flot.min.js"></script>
    <link rel="stylesheet" type="text/css" href="{{ basepath }}/static/css/tabs.css" />
{% endblock %}

{% block content %}
<div class="section">
<div class="profile {% if group.parent %}group-{{ group.parent.name.lower }}{% endif %} group-{{ group.name.lower }}">
    {% if group.image %}
    <div class="banner">
        <img class="banner" src="{{group.path}}" />
    </div>
    {% endif %}
    <div class="points">
        <div class="points-big">{{ group.live_points }}</div>
        <div class="rank">{% if top.disabled %}-{% else %}{% trans 'rank' %}: {{ top.position }}{% endif %}</div>
    </div>
    <div id="profile-info">
        <h2>
            {{ group.name }}
        </h2>
        <h3>{{ group.group_type }}</h3>
        {% if group.group_type.parent_type %}
            <h4>{{ group.group_type.parent_type }}: {% player_group group.parent %}</h4>
        {% endif %}
        <p>{{ group.players.count }} {% trans 'members' %}</p>
    </div>

    <div class="second">
    </div>

    <div class="section-content">
    <ul class="tabs">
        <li><a href="#tab-1">{% trans 'Top users' %}</a></li>
        {% if top_subgroups %}
            <li><a href="#tab-2">{% trans 'Top subgroups' %}</a></li>
        {% endif %}
        <li><a href="#tab-3">{% trans 'Activity' %}</a></li>
        <li><a href="#tab-4">{% trans 'Evolution' %}</a></li>
    </ul>

    <div class="tab_container">
        <div id="tab-1" class="tab_content">
            <table>
                <tr>
                    <th>#</th>
                    <th width="100%">Name</th>
                    <th>Group</th>
                    <th>Points</th>
                </tr>
                {% for u in top_users %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{% player u %}</td>
                    <td>{% player_group u.group %}</td>
                    <td>{{ u.points }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>

        <div id="tab-2" class="tab_content">
            <table>
                <tr>
                    <th>#</th>
                    <th width="100%">Name</th>
                    <th>Points</th>
                </tr>
                {% for s in top_subgroups %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{% player_group s %}</td>
                    <td>{{ s.live_points }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>

        <div id="tab-3" class="tab_content">
            {% include 'activity/stream.html' %}
        </div>

        <!-- TODO: FIX ME -->
        <div id="tab-4" class="tab_content">
            <div class="subgroups">
                <h3>{% trans 'Rank' %}</h3>
                <p>{% trans 'Global' %}: <span class="points">{{ top.position }}</span></p>
                {% if group.parent %}
                <p>{{group.parent}}: <span class="points">{{ top.position_in_parent }}</span></p>
                {% endif %}

                <h3>{% trans 'Position evolution' %}</h3>
                <p>{% trans 'Position evolution compared with groups of the same kind.' %}</p>
                <div id="legend"></div>
            </div>
            <div id="graf1" class="graf placeholder"></div>
            <script id="source" language="javascript" type="text/javascript">
            <!-- using flot to draw evolution -->
            $(function () {
                var d{{ group.id }} = [[null, 12],{% for p in top.week_evolution %}[{{p.0}},{{p.1}}],{% endfor %}[7, null]];
                {% for g in group.sisters %}
                    var d{{ g.id }} = [{% for p in g.top.week_evolution %}[{{ p.0 }},{{ p.1 }}],{% endfor %}];
                {% endfor %}
                var options = { lines: { show: true }, points: { show: true },
                    xaxis: {
                        ticks: [[1,1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,7]]
                        },
                    yaxis: {
                        transform: function (v) { return -v; },
                        inverseTransform: function (v) { return -v; },
                    },
                    legend: {
                        container: $('#legend'),
                    },
                };
                $("#tab-3").bind('custom', function() {
                    $.plot($("#graf1"), [{ label: "<strong>{{ group.name }}</strong>", color: "green", data: d{{ group.id }} }, {% for g in group.sisters %}{label: "{{ g.name }}", data:d{{ g.id }}},{% endfor %}], options);
                    $('#tab-3').unbind('custom');
                });
            });
            </script>
        </div>
        <!-- END TODO -->
    </div>
</div>
</div>
{% endblock %}
